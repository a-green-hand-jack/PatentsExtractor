<!--
本模板由 Gemini 2.5 Pro 创建，旨在引导用户与 AI 助手进行结构化的项目启动讨论。

使用说明：
AI 助手你好，请你扮演一名经验丰富、代码风格严谨的 Python 技术专家和架构师。
当我提供这个文件作为上下文时，你的任务是与我协作，通过对话的方式逐一完成以下清单，
并把我们的讨论结果和最终决策填入对应的 `[待填写]` 和 `讨论记录` 部分。
你的目标是帮助我将这个模板文件最终转变为一份完整、清晰、可执行的项目初始化文档。
请主动引导讨论，确保我们覆盖了所有关键点。
-->

# Patents Extractor - 项目初始化协作文档

**目标**: 本文档旨在通过与 AI 助手的协作讨论，明确项目 `Patents Extractor` 的核心需求、技术方案和实施计划，最终形成一份完整的项目启动说明。

---

## 1. 项目概述 (Overall Vision)

- **项目名称**: `Patents Extractor` (专利提取器)
- **一句话描述**: 一个将专利 PDF 文件高效解析为包含文本、图表、表格等内容的结构化、便于大语言模型处理的工具。
- **最终交付物**: 一个可以通过 `uv run` 调用的命令行工具，能够接收 PDF 文件路径作为输入，并输出结构化的数据。
- **状态**: `[ ] 讨论中` `[x] 已确认`

### 讨论记录:
> **AI**: 我根据您的描述，为项目拟定了以上基本信息。
> - **项目名称** 直接反映了其核心功能。
> - **一句话描述** 强调了其产出是为 LLM 服务的。
> - **最终交付物** 定义为一个命令行工具，这是最直接和可扩展的交付形式。
>
> **您对这部分有什么建议或补充吗？**

---

## 2. 详细需求 (Detailed Requirements)

### 2.1. 输入处理 (Input Handling)
- **需求描述**:
  1.  **输入源**: 支持单个或批量（指定目录）的专利 PDF 文件。
  2.  **PDF 类型**: 需要能同时处理两种主流 PDF 类型：
      - **标准 PDF**: 文本内容可选、可直接提取。
      - **扫描件 PDF**: 完全由图像构成，需要依赖 OCR 技术。
- **状态**: `[x] 讨论中` `[ ] 已确认`

### 讨论记录:
> **AI**: 这是从您的流程图中总结出的输入需求。我们是否还需要考虑从 URL 或其他数据源获取 PDF？
> **您**: 我们现在不考虑其他来源的 pdf，pdf 就是用户直接提供的。
> **AI**: 好的，输入范围已明确。

### 2.2. 核心功能 (Core Functionality)
- **需求描述**:
  1.  **PDF 结构化**: 采用先进的文档解析模型，对 PDF 进行深度分析，提取以下元素：
      - **纯文本内容**: 保持原始段落结构。
      - **插图 (Figures)**: 提取图片并保存为独立文件。
      - **表格 (Tables)**: 识别表格并将其内容转换为结构化格式。
      - **序列 (Sequences)**: 识别并提取专利中特定的氨基酸或核苷酸序列。**[第一阶段]** 可先作为普通文本提取。
      - **化学分子式 (Molecular Formulas)**: 识别并提取化学结构图或分子式。**[第一阶段]** 可先作为普通图片 (`Figure`) 提取。
  2.  **OCR 优化**: 针对扫描件，需要有强大的 OCR 能力，并能处理识别混淆（如 `1` 和 `l`，`0` 和 `O`）。
- **状态**: `[ ] 讨论中` `[x] 已确认`

### 讨论记录:
> **AI**: 核心功能是项目的关键。除了基本的文本、图像、表格外，我特别列出了专利领域常见的“序列”和“化学分子式”作为待讨论项。提取这两类信息通常需要领域特定的模型或规则，可能会增加项目的复杂度。我们初期是否要包含这两项？
> **您**: 确认需要包含这两项。初期可以先进行降级处理：序列按纯文本提取，化学分子式按图片提取。
> **AI**: 好的，已将此作为明确需求更新。

### 2.3. 输出格式 (Output Format)
- **需求描述**: 为每个输入的 PDF 生成一个同名的输出目录，其中包含两种格式的结构化数据：
    1.  **Markdown 格式**:
        - `content.md`: 一个 Markdown 主文件，按顺序组织所有文本内容。表格直接以 Markdown 表格语法内嵌，图片以内联方式引用。
        - `figures/`: 存放所有提取出的**高质量**图片文件（如 `fig_1.png`）。
    2.  **JSON 格式**:
        - `content.json`: 一个 JSON 主文件，包含所有文本内容和元数据。
        - `figures/`: 存放所有提取出的**高质量**图片文件，JSON 文件中通过相对路径引用。
        - `tables/`: 存放所有提取出的表格文件（如 `table_1.csv`），JSON 文件中通过相对路径引用。
- **状态**: `[x] 讨论中` `[ ] 已确认`

### 讨论记录:
> **AI**: 这种输出格式（Markdown + 资源文件夹）具有极佳的可读性，同时也方便程序进行解析。另一种常见的格式是输出一个大的 JSON 文件，将所有信息（包括图片进行 base64 编码）包含在内。您认为哪种更适合我们的下游 LLM 应用？
> **您**: 需要同时支持 Markdown 和 JSON 两种格式，具体要求如上所述。图片需要保证高质量，不进行有损压缩。
> **AI**: 明白，双格式输出是更灵活的设计，已更新。

---

## 3. 技术选型 (Technical Stack)

- **技术栈描述**:
  - **核心解析引擎**: 建议选用 **`Marker`** (https://github.com/VikParuchuri/marker)。它是一个基于 PyTorch 和 Transformer 的深度学习模型，专门用于将 PDF/EPUB/MOBI 精确转换为 Markdown，非常适合处理学术和技术文档，与我们的需求高度相关。
  - **编程语言**: Python 3.10+
  - **核心依赖库**:
    - `torch`: `Marker` 模型的底层依赖。
    - `pathlib`: 用于跨平台的文件路径操作。
    - `logging`: 用于记录程序运行日志。
    - `uv`: 用于项目环境和依赖管理。
    - `hatchling`: 用于项目打包构建。
- **状态**: `[ ] 讨论中` `[x] 已确认`

### 讨论记录:
> **AI**: 如开头所述，我推荐使用 `Marker` 作为我们的起点。它的优势在于将 OCR 和文本结构化一步完成，并且在处理复杂的文档布局（如多栏、页眉页脚）方面效果很好。我们可以先用它来快速验证整体流程，如果后续在特定专利格式上效果不佳，再考虑在其基础上进行微调或开发专用模块。
> **您**: 同意。可以先选用 `Marker` (https://github.com/VikParuchuri/marker)。另外有一个备选方案 `MinerU` (https://github.com/opendatalab/MinerU)，但它看起来更复杂，我们可以后续再评估。
> **AI**: 好的。我们以 `Marker` 作为 PoC 阶段的核心引擎，`MinerU` 作为潜在的备选方案记录在案。

---

## 4. 架构与设计 (Architecture & Design)

### 4.1. 项目结构 (Project Structure)
- **设计要求**: 严格遵循我为您提供的 **Python 标准化项目结构模板**，采用 `src` 布局。
  - 核心逻辑: `src/patents_extractor/`
  - 测试代码: `tests/`
  - 命令行脚本入口: `src/patents_extractor/cli.py`
  - 辅助脚本: `scripts/`
- **状态**: `[ ] 讨论中` `[x] 已确认`

### 讨论记录:
> **AI**: 这部分我们将严格按照已定义的最佳实践来执行，确保项目的可维护性和扩展性。

### 4.2. 关键设计决策 (Key Design Decisions)
- **决策点**:
  1.  **统一处理流程**: 设计一个统一的 `Processor` 接口，无论 PDF 是标准型还是扫描型，都通过同一个入口调用。`Marker` 自身已经能较好地处理混合类型的 PDF，我们可以将这种复杂性封装在内部。
  2.  **模块化设计**:
      - `loader`: 负责加载和初步校验 PDF 文件。
      - `parser`: 核心模块，封装 `Marker` 的调用逻辑。
      - `extractor`: 在 `parser` 的基础上，进一步提取特定信息（如序列、分子式）的扩展模块。
      - `writer`: 负责将提取出的结构化数据写入我们定义的输出格式。
  3.  **配置驱动**: 将关键参数（如 `Marker` 模型的本地路径、输出目录、日志级别等）通过配置文件进行管理，而非硬编码。
- **状态**: `[ ] 讨论中` `[x] 已确认`

### 讨论记录:
> **AI**: 我提出了一个初步的模块化设计思路，将整个流程拆分为加载、解析、提取和写入四个阶段。这样做的好处是，未来如果我们想替换核心解析器（例如从 `Marker` 换成其他工具），或者增加新的提取目标（例如增加对专利引用的提取），我们只需要修改或增加对应的模块，而不会影响整个代码库。您觉得这个设计思路是否清晰？
> **您**: 架构是合适的。
> **AI**: 收到。

---

## 5. 文档与测试 (Documentation & Testing)

- **要求描述**:
  - **代码文档**: 所有代码必须包含符合 Google 风格的中文 Docstrings 和精确的类型注解。
  - **单元测试**: 核心功能模块（特别是 `extractor` 和 `writer`）必须编写相应的 `pytest` 单元测试。
  - **集成测试**: 至少提供一个完整的集成测试，使用 `./data/pdf` 中的示例文件，验证从 PDF 输入到结构化输出的整个流程能正确运行。
  - **测试输出**: 所有由测试脚本产生的输出文件，都必须存放到 `./test_output/{测试脚本同名的文件夹}/{测试时间戳}/` 目录下，以隔离测试产物。
  - **项目文档**: `README.md` 需包含清晰的安装、配置和使用说明。
- **状态**: `[ ] 讨论中` `[x] 已确认`

### 讨论记录:
> **AI**: 这部分我们将遵循您提供的编码规范，确保代码质量和项目的可维护性。
> **您**: 同意，并补充了对测试输出路径的规范。
> **AI**: 收到，已将测试输出规范更新至文档。

---

## 6. 总结与下一步 (Summary & Next Steps)

- **项目初始化确认**: `[x] 所有章节已确认`
- **下一步计划**:
  1.  **环境搭建**: 使用 `uv` 创建虚拟环境，并安装 `Marker` 及其依赖。
  2.  **可行性验证 (PoC)**: 编写一个位于 `scripts/` 目录下的简单脚本，直接调用 `Marker` 处理 `./data/pdf` 中的 `CN202210107337.pdf` 文件，将结果输出到 `output/` 目录。
  3.  **评估结果**: 我们一起检查 PoC 的输出质量，判断 `Marker` 在处理真实专利文件时的初步效果。
- **状态**: `[ ] 讨论中` `[x] 已确认`

### 讨论记录:
> **AI**: 我建议我们的第一步是进行一个快速的技术验证（PoC），而不是立即开始构建完整的项目框架。这样可以让我们以最小的成本快速了解核心技术的可行性和潜在问题。如果 PoC 的结果令人满意，我们再着手搭建正式的项目结构。您同意这个计划吗？
> **您**: 下一步计划是可行的。
> **AI**: 好的，规划阶段完成。我们正式进入 PoC 实施阶段。
